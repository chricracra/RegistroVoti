{% extends "base.html" %}
{% block content %}
<div class="dashboard-container">
    <h1>Dashboard</h1>
    
    <!-- Riga Superiore: Media Generale + Grafico Radar -->
    <div class="top-row">
        <!-- Box Media Generale -->
        <div class="summary-box">
            <h3>Media Generale</h3>
            <div class="average-value">{{ overall_avg }}</div>
            <div class="performance-text">
                {% if overall_avg >= 8 %} 
                    <span style="color: var(--success);">Ottimo!</span>
                {% elif overall_avg >= 6 %} 
                    <span style="color: var(--warning);">Buono</span>
                {% else %}
                    <span style="color: var(--danger);">Da migliorare</span>
                {% endif %}
            </div>
        </div>

        <!-- Grafico Radar Semplificato -->
        <div class="radar-container">
            <canvas id="radarChart"></canvas>
        </div>
    </div>
    
    <!-- Aggiungi Materia -->
    <div class="subject-card" style="margin-bottom: 2rem;">
        <form action="{{ url_for('add_subject') }}" method="POST">
            <div class="add-grade-form">
                <input type="text" name="name" placeholder="Aggiungi una nuova materia" required>
                <button type="submit" class="btn-primary">Aggiungi</button>
            </div>
        </form>
    </div>

    <!-- Materie -->
    <div class="subjects-grid">
        {% for subject in subjects %}
        <div class="subject-card">
            <div class="subject-header">
                <h2 class="subject-name">{{ subject.name }}</h2>
                <div class="subject-avg">{{ subject.avg }}</div>
            </div>
            
            <!-- Form Aggiungi Voto -->
            <form action="{{ url_for('add_grade') }}" method="POST">
                <input type="hidden" name="subject_id" value="{{ subject.id }}">
                <div class="add-grade-form">
                    <input type="number" step="0.1" min="0" max="10" name="value" placeholder="Voto" required>
                    <input type="number" step="0.1" min="0.1" name="weight" placeholder="Peso" value="1.0" required>
                    <button type="submit">+</button>
                </div>
            </form>
            
            <!-- Lista Voti -->
            <div class="grades-list">
                {% for grade in subject.grades|sort(attribute='date', reverse=true) %}
                <div class="grade-item">
                    <span class="grade-value">{{ grade.value }} (x{{ grade.weight }})</span>
                    <div>
                        <span class="grade-date">{{ grade.date.strftime('%d/%m') }}</span>
                        <a href="{{ url_for('delete_grade', grade_id=grade.id) }}" class="delete-btn">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </div>
                {% else %}
                <p style="text-align: center; margin-top: 1rem;">Nessun voto registrato</p>
                {% endfor %}
            </div>
            
            <a href="{{ url_for('subject', id=subject.id) }}" style="display: block; text-align: center; margin-top: 1rem;">
                <i class="fas fa-chart-line"></i> Dettagli
            </a>
        </div>
        {% else %}
        <div class="subject-card">
            <h3 style="text-align: center;">Nessuna materia registrata</h3>
            <p style="text-align: center; margin-top: 1rem;">Aggiungi una materia per iniziare</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // Configurazione Radar Semplificato
    const radarCtx = document.getElementById('radarChart').getContext('2d');
    new Chart(radarCtx, {
        type: 'radar',
        data: {
            labels: {{ subjects|map(attribute='name')|tojson }},
            datasets: [{
                label: 'Media',
                data: {{ subjects|map(attribute='avg')|tojson }},
                backgroundColor: 'rgba(37, 117, 252, 0.2)',
                borderColor: '#2575fc',
                borderWidth: 2,
                pointBackgroundColor: '#2575fc',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: '#2575fc'
            }]
        },
        options: {
            scales: {
                r: {
                    angleLines: {
                        display: true,
                        color: 'rgba(200, 200, 200, 0.3)'
                    },
                    suggestedMin: 0,
                    suggestedMax: 10,
                    ticks: {
                        stepSize: 2,
                        showLabelBackdrop: false,
                        callback: function(value) {
                            return value === 10 ? '10' : '';
                        }
                    },
                    pointLabels: {
                        font: {
                            size: 11
                        },
                        color: 'var(--text-color)'
                    },
                    grid: {
                        color: 'var(--border-color)'
                    }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Media: ${context.raw}`;
                        }
                    }
                }
            },
            maintainAspectRatio: false,
            responsive: true
        }
    });
</script>
{% endblock %}
